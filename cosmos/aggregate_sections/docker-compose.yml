version: "3"

networks:
  default:
    external:
      name: cosmos_swarm_network 
services:
    aggregate_sections:
        image: iaross/aggregate_sections_test:latest
        ipc: host
        command: "python3 -m agg.aggregate"
        environment:
            - DATASET_ID=3271e2ab-6aba-4d0f-9f07-50bc7129f5eb
            - MYSQL_USER=myuser
            - MYSQL_DATABASE=cosmos
            - MYSQL_PASSWORD=cosmos123
        #networks:
        #    cosmos_swarm_network:
        depends_on:
            - scheduler

    scheduler:
        image: iaross/aggregate_sections_test:latest
        #networks:
        #    cosmos_swarm_network:
        command: "dask-scheduler --port 8788"
        ports:
            - 8788:8786

    worker1:
        image: iaross/aggregate_sections_test:latest
        #networks:
        #    cosmos_swarm_network:
        environment:
            - MYSQL_USER=myuser
            - MYSQL_DATABASE=cosmos
            - MYSQL_PASSWORD=cosmos123
            - CUDA_VISIBLE_DEVICES=''
        command: "dask-worker tcp://scheduler:8788 --nprocs 1 --resources 'agg=1'"
        depends_on:
            - scheduler


